events { 
}

http {
    include /etc/nginx/mime.types;

    server {
        listen 80;
        server_name app.t1-check-mates.mooo.com;
        include errorpages.conf; 

        location /.well-known/acme-challenge/ {
          root /var/www/certbot;
        }

        location / {
          return 301 https://app.t1-check-mates.mooo.com$request_uri;
        }
        #location /backend {
        #  return 301 https://app.t1-check-mates.mooo.com/backend$request_uri;
        #}
        # location / {
        #     proxy_set_header Host $http_host;
        #     proxy_set_header X-Real-IP $remote_addr;
        #     proxy_set_header X-Scheme $scheme;
        #     proxy_set_header X-Forwarded-Proto $scheme;
        #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        #     proxy_redirect off;
        #     proxy_pass http://host.docker.internal:3000;
        # }

        # location /backend {
        #     rewrite /backend/(.*) /$1 break;
        #     proxy_http_version 1.1;
        #     proxy_set_header Host $http_host;
        #     proxy_set_header X-Real-IP $remote_addr;
        #     proxy_set_header X-Scheme $scheme;
        #     proxy_set_header X-Forwarded-Proto $scheme;
        #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        #     # added two for websocket?
        #     proxy_set_header Upgrade $http_upgrade;
        #     proxy_set_header Connection "Upgrade";
        #     proxy_redirect off;
        #     proxy_pass http://host.docker.internal:8000;
        # }
    }

    server {
        listen 443 ssl;
        server_name app.t1-check-mates.mooo.com;
        include errorpages.conf; 

        ssl_certificate /etc/letsencrypt/ssl/live/app.t1-check-mates.mooo.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/ssl/live/app.t1-check-mates.mooo.com/privkey.pem;

        #location / {
        #  return 301 http://app.t1-check-mates.mooo.com$request_uri;
        #}
        location / {
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Scheme $scheme;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_redirect off;
            proxy_pass http://host.docker.internal:3000;
        }

        location /backend {
            rewrite /backend/(.*) /$1 break;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Scheme $scheme;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # added two for websocket?
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            #proxy_http_version 1.1;

            proxy_redirect off;
            proxy_pass http://host.docker.internal:8000;
        }
    }

    server {
        listen 80;
        server_name t1-check-mates.mooo.com;

	      root /usr/share/nginx/html;
	      index index.html;
        include errorpages.conf; 

        location /.well-known/acme-challenge/ {
          root /var/www/certbot;
        }

        location / {
          return 301 https://t1-check-mates.mooo.com$request_uri;
        }

    }

    server {
        listen 443 ssl;
        server_name t1-check-mates.mooo.com;
	      root /usr/share/nginx/html;
	      index index.html;
        include errorpages.conf; 

        ssl_certificate /etc/letsencrypt/ssl/live/t1-check-mates.mooo.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/ssl/live/t1-check-mates.mooo.com/privkey.pem;

        location /webhook {
          proxy_pass http://host.docker.internal:5000/;
        }

        location /sourcecode {
          rewrite /sourcecode/(.*) /$1 break;
          proxy_set_header Host $http_host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Scheme $scheme;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_redirect off;
          proxy_pass http://host.docker.internal:8888;
        }
    }

    server {
        listen 80;
        server_name taiga.t1-check-mates.mooo.com;
        include errorpages.conf; 

        location /.well-known/acme-challenge/ {
          root /var/www/certbot;
        }

        location / {
          return 301 https://taiga.t1-check-mates.mooo.com$request_uri;
        }
    }

    server {
        listen 443 ssl;
        server_name taiga.t1-check-mates.mooo.com;
        client_max_body_size 100M;
        charset utf-8;
        include errorpages.conf; 

        ssl_certificate /etc/letsencrypt/ssl/live/taiga.t1-check-mates.mooo.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/ssl/live/taiga.t1-check-mates.mooo.com/privkey.pem;

        location / {
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Scheme $scheme;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_redirect off;
            proxy_pass http://host.docker.internal:9000;
        }
    }

    server {
        listen 80;
        server_name gitlab.t1-check-mates.mooo.com;
        client_max_body_size 100M;
        charset utf-8;
        include errorpages.conf; 

        location /.well-known/acme-challenge/ {
          root /var/www/certbot;
        }

        location / {
          return 301 https://gitlab.t1-check-mates.mooo.com$request_uri;
        }
    }
     
    server {
        listen 443 ssl;
        server_name gitlab.t1-check-mates.mooo.com;
        client_max_body_size 100M;
        charset utf-8;
        include errorpages.conf; 

        ssl_certificate /etc/letsencrypt/ssl/live/gitlab.t1-check-mates.mooo.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/ssl/live/gitlab.t1-check-mates.mooo.com/privkey.pem;

        location / {
	          proxy_hide_header X-Frame-Options;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Scheme $scheme;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_redirect off;
            proxy_pass http://host.docker.internal:8080;
        }
    }

    server {
        listen 80;
        server_name mattermost.t1-check-mates.mooo.com;
        client_max_body_size 100M;
        charset utf-8;
        include errorpages.conf; 

        location /.well-known/acme-challenge/ {
          root /var/www/certbot;
        }

        location / {
          return 301 https://mattermost.t1-check-mates.mooo.com$request_uri;
        }
    }

    server {
        listen 443 ssl;
        server_name mattermost.t1-check-mates.mooo.com;
        client_max_body_size 100M;
        charset utf-8;
        include errorpages.conf; 

        ssl_certificate /etc/letsencrypt/ssl/live/mattermost.t1-check-mates.mooo.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/ssl/live/mattermost.t1-check-mates.mooo.com/privkey.pem;

      	add_header X-XSS-Protection "1; mode=block" always;
      	add_header X-Content-Type-Options "nosniff" always;
      	add_header Referrer-Policy no-referrer;
      	add_header Strict-Transport-Security "max-age=63072000" always;
      	add_header Permissions-Policy "interest-cohort=()";
	      add_header Content-Security-Policy "frame-ancestors 'self' http://t1-check-mates.mooo.com; script-src 'self' cdn.rudderlabs.com cdn.segment.com/analytics.js/";

        location ~ /api/v[0-9]+/(users/)?websocket$ {
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            client_max_body_size 50M;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Early-Data $ssl_early_data;
	          proxy_hide_header Content-Security-Policy;
	          proxy_hide_header X-Frame-Options;
            proxy_buffers 256 16k;
            proxy_buffer_size 16k;
            client_body_timeout 60;
            send_timeout 300;
            lingering_timeout 5;
            proxy_connect_timeout 90;
            proxy_send_timeout 300;
            proxy_read_timeout 90s;
            proxy_http_version 1.1;
            proxy_pass http://host.docker.internal:8065;
        }

        location / {
            client_max_body_size 50M;
            proxy_set_header Connection "";
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Early-Data $ssl_early_data;
	          proxy_hide_header Content-Security-Policy;
	          proxy_hide_header X-Frame-Options;
            proxy_buffers 256 16k;
            proxy_buffer_size 16k;
            proxy_read_timeout 600s;
            proxy_cache_revalidate on;
            proxy_cache_min_uses 2;
            proxy_cache_use_stale timeout;
            proxy_cache_lock on;
            proxy_http_version 1.1;
            proxy_pass http://host.docker.internal:8065;
        }
    }

    server {
        listen 80;
        server_name sonarqube.t1-check-mates.mooo.com;
        client_max_body_size 100M;
        charset utf-8;
        include errorpages.conf; 

        location /.well-known/acme-challenge/ {
          root /var/www/certbot;
        }

        location / {
          return 301 https://sonarqube.t1-check-mates.mooo.com$request_uri;
        }
    }

    server {
        listen 443 ssl;
        server_name sonarqube.t1-check-mates.mooo.com;
        client_max_body_size 100M;
        charset utf-8;
        include errorpages.conf; 

        ssl_certificate /etc/letsencrypt/ssl/live/sonarqube.t1-check-mates.mooo.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/ssl/live/sonarqube.t1-check-mates.mooo.com/privkey.pem;

        location / {
	          proxy_hide_header X-Frame-Options;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Scheme $scheme;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_redirect off;
            proxy_pass http://host.docker.internal:9009;
        }
    }

    server {
        listen 80;
        server_name time.t1-check-mates.mooo.com;
        client_max_body_size 100M;
        charset utf-8;
        include errorpages.conf; 

        location /.well-known/acme-challenge/ {
          root /var/www/certbot;
        }

        location / {
          return 301 https://time.t1-check-mates.mooo.com$request_uri;
        }
    }

    server {
 	      listen 443 ssl;
 	      server_name time.t1-check-mates.mooo.com;
        include errorpages.conf; 

        ssl_certificate /etc/letsencrypt/ssl/live/time.t1-check-mates.mooo.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/ssl/live/time.t1-check-mates.mooo.com/privkey.pem;

        return      301 https://docs.google.com/spreadsheets/d/1Sohx3VTqyOKFi-2p7h-YRqwgnrcxeq5NX3CueHe-qLI;
    }
}
